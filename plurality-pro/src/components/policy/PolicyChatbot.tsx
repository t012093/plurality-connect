import React, { useState, useRef, useEffect } from 'react';
import styled from 'styled-components';
import { PolicyData, ChatMessage } from '../../pages/PolicyKnowledgePage';

const ChatbotContainer = styled.div`
  height: 100%;
  display: flex;
  flex-direction: column;
  background: rgba(15, 23, 42, 0.8);
`;

const ChatbotHeader = styled.div`
  padding: 20px 25px 15px 25px;
  border-bottom: 1px solid rgba(51, 65, 85, 0.3);
  background: rgba(15, 23, 42, 0.9);
`;

const HeaderTitle = styled.h3`
  color: #f1f5f9;
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
`;

const HeaderDescription = styled.p`
  color: #94a3b8;
  font-size: 13px;
  margin: 0 0 12px 0;
  line-height: 1.4;
`;

const StatusIndicator = styled.div<{ online: boolean }>`
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: ${props => props.online ? '#10b981' : '#64748b'};
`;

const StatusDot = styled.div<{ online: boolean }>`
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: ${props => props.online ? '#10b981' : '#64748b'};
  animation: ${props => props.online ? 'pulse 2s infinite' : 'none'};
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
`;

const ChatMessages = styled.div`
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
`;

const MessageBubble = styled.div<{ type: 'user' | 'bot' }>`
  max-width: 85%;
  align-self: ${props => props.type === 'user' ? 'flex-end' : 'flex-start'};
  background: ${props => props.type === 'user' 
    ? 'linear-gradient(135deg, #06b6d4, #0891b2)' 
    : 'rgba(51, 65, 85, 0.6)'};
  color: #f1f5f9;
  padding: 12px 16px;
  border-radius: ${props => props.type === 'user' 
    ? '18px 18px 4px 18px' 
    : '18px 18px 18px 4px'};
  font-size: 14px;
  line-height: 1.5;
  border: 1px solid ${props => props.type === 'user' 
    ? 'rgba(6, 182, 212, 0.3)' 
    : 'rgba(71, 85, 105, 0.3)'};
  backdrop-filter: blur(10px);
`;

const MessageTime = styled.div`
  font-size: 11px;
  color: #64748b;
  margin-top: 4px;
  text-align: right;
`;

const PolicyReference = styled.div`
  background: rgba(6, 182, 212, 0.1);
  border: 1px solid rgba(6, 182, 212, 0.3);
  border-radius: 8px;
  padding: 8px 12px;
  margin-top: 8px;
  font-size: 12px;
  color: #06b6d4;
  cursor: pointer;
  transition: all 0.3s ease;
  
  &:hover {
    background: rgba(6, 182, 212, 0.2);
    border-color: #06b6d4;
  }
`;

const TypingIndicator = styled.div`
  display: flex;
  align-items: center;
  gap: 8px;
  color: #94a3b8;
  font-size: 13px;
  font-style: italic;
  margin-left: 16px;
`;

const TypingDots = styled.div`
  display: flex;
  gap: 4px;
  
  span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #94a3b8;
    animation: typing 1.4s infinite ease-in-out;
    
    &:nth-child(1) { animation-delay: 0s; }
    &:nth-child(2) { animation-delay: 0.2s; }
    &:nth-child(3) { animation-delay: 0.4s; }
  }
  
  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
  }
`;

const InputSection = styled.div`
  padding: 16px 20px;
  border-top: 1px solid rgba(51, 65, 85, 0.3);
  background: rgba(15, 23, 42, 0.9);
`;

const QuickActions = styled.div`
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
`;

const QuickActionButton = styled.button`
  background: rgba(51, 65, 85, 0.5);
  border: 1px solid rgba(71, 85, 105, 0.5);
  color: #cbd5e1;
  padding: 6px 12px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  
  &:hover {
    background: rgba(6, 182, 212, 0.2);
    color: #06b6d4;
    border-color: #06b6d4;
  }
`;

const InputContainer = styled.div`
  display: flex;
  gap: 8px;
  align-items: flex-end;
`;

const MessageInput = styled.textarea`
  flex: 1;
  background: rgba(51, 65, 85, 0.5);
  border: 1px solid rgba(71, 85, 105, 0.5);
  color: #f1f5f9;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
  resize: none;
  min-height: 44px;
  max-height: 120px;
  
  &:focus {
    outline: none;
    border-color: #06b6d4;
    background: rgba(6, 182, 212, 0.1);
  }
  
  &::placeholder {
    color: #64748b;
  }
`;

const SendButton = styled.button<{ disabled?: boolean }>`
  background: ${props => props.disabled 
    ? 'rgba(51, 65, 85, 0.5)' 
    : 'linear-gradient(135deg, #06b6d4, #0891b2)'};
  border: 1px solid ${props => props.disabled 
    ? 'rgba(71, 85, 105, 0.5)' 
    : '#06b6d4'};
  color: ${props => props.disabled ? '#64748b' : '#f1f5f9'};
  padding: 12px 16px;
  border-radius: 12px;
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 44px;
  
  &:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
  }
`;

interface PolicyChatbotProps {
  policies: PolicyData[];
}

const PolicyChatbot: React.FC<PolicyChatbotProps> = ({ policies }) => {
  const [messages, setMessages] = useState<ChatMessage[]>([
    {
      id: '1',
      type: 'bot',
      content: '„Åì„Çì„Å´„Å°„ÅØÔºÅÊîøÁ≠ñAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÊîøÁ≠ñ„Å´Èñ¢„Åô„Çã„ÅîË≥™Âïè„ÇÑÂàÜÊûê„Çí„ÅäÊâã‰ºù„ÅÑ„Åó„Åæ„Åô„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™„Åì„Å®„Çí„ÅäËÅû„Åç„Å´„Å™„Çä„Åü„ÅÑ„Åß„Åô„ÅãÔºü',
      timestamp: new Date(),
    }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [isOnline] = useState(true);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const quickActions = [
    'ÊîøÁ≠ñ„ÅÆÂΩ±ÈüøÂ∫¶„ÇíÊØîËºÉ',
    '‰∫àÁÆóÈÖçÂàÜ„ÇíÁ¢∫Ë™ç',
    'Èñ¢ÈÄ£ÊîøÁ≠ñ„ÇíË°®Á§∫',
    'ÂÆüË£ÖÁä∂Ê≥Å„ÇíÊïô„Åà„Å¶',
    '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ„ÉºÂàÜÊûê'
  ];

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isTyping]);

  const generateBotResponse = (userMessage: string): string => {
    const message = userMessage.toLowerCase();
    
    if (message.includes('ÂΩ±ÈüøÂ∫¶') || message.includes('ÊØîËºÉ')) {
      const sortedPolicies = [...policies].sort((a, b) => b.impactScore - a.impactScore);
      return `ÂΩ±ÈüøÂ∫¶„ÅÆÈ´ò„ÅÑÊîøÁ≠ñ„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„Åß„ÅôÔºö\n\n1. ${sortedPolicies[0]?.title} (ÂΩ±ÈüøÂ∫¶: ${sortedPolicies[0]?.impactScore})\n2. ${sortedPolicies[1]?.title} (ÂΩ±ÈüøÂ∫¶: ${sortedPolicies[1]?.impactScore})\n3. ${sortedPolicies[2]?.title} (ÂΩ±ÈüøÂ∫¶: ${sortedPolicies[2]?.impactScore})\n\nË©≥Á¥∞„Å™ÂàÜÊûê„Çí„ÅîÂ∏åÊúõ„Åß„Åó„Åü„Çâ„ÄÅÁâπÂÆö„ÅÆÊîøÁ≠ñÂêç„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ`;
    }
    
    if (message.includes('‰∫àÁÆó') || message.includes('ÈÖçÂàÜ')) {
      const totalBudget = policies.reduce((sum, policy) => sum + policy.budget.total, 0);
      const avgBudget = totalBudget / policies.length;
      return `ÁèæÂú®„ÅÆÊîøÁ≠ñ‰∫àÁÆóÁä∂Ê≥ÅÔºö\n\n‚Ä¢ Á∑è‰∫àÁÆó: ¬•${(totalBudget / 1000000).toFixed(0)}M\n‚Ä¢ Âπ≥Âùá‰∫àÁÆó: ¬•${(avgBudget / 1000000).toFixed(1)}M\n‚Ä¢ ÊúÄÂ§ß‰∫àÁÆó: ${policies.reduce((max, p) => p.budget.total > max.budget.total ? p : max).title}\n\nÂÖ∑‰ΩìÁöÑ„Å™‰∫àÁÆóÂÜÖË®≥„ÇÑ‰ΩøÁî®Áä∂Ê≥Å„Å´„Å§„ÅÑ„Å¶„ÇÇ„ÅäÁ≠î„Åà„Åß„Åç„Åæ„Åô„ÄÇ`;
    }
    
    if (message.includes('Èñ¢ÈÄ£') || message.includes('Èñ¢‰øÇ')) {
      const connectionsCount = policies.reduce((sum, policy) => sum + policy.relatedPolicies.length, 0);
      return `ÊîøÁ≠ñÈñì„ÅÆÈñ¢ÈÄ£ÊÄßÂàÜÊûêÔºö\n\n‚Ä¢ Á∑èÈñ¢ÈÄ£Êï∞: ${connectionsCount}\n‚Ä¢ ÊúÄ„ÇÇÈñ¢ÈÄ£„ÅÆÂ§ö„ÅÑÊîøÁ≠ñ: ${policies.reduce((max, p) => p.relatedPolicies.length > max.relatedPolicies.length ? p : max).title}\n\nÊîøÁ≠ñÈñì„ÅÆÁõ∏‰∫í‰ΩúÁî®„ÇÑ‰æùÂ≠òÈñ¢‰øÇ„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèÁü•„Çä„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÊîøÁ≠ñÂêç„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ`;
    }
    
    if (message.includes('ÂÆüË£Ö') || message.includes('Áä∂Ê≥Å') || message.includes('ÈÄ≤Êçó')) {
      const implemented = policies.filter(p => p.status === 'implemented').length;
      const approved = policies.filter(p => p.status === 'approved').length;
      const review = policies.filter(p => p.status === 'review').length;
      const draft = policies.filter(p => p.status === 'draft').length;
      
      return `ÊîøÁ≠ñÂÆüË£ÖÁä∂Ê≥Å„ÅÆÊ¶ÇË¶ÅÔºö\n\n‚úÖ ÂÆüË£ÖÊ∏à„Åø: ${implemented}‰ª∂\nüîµ ÊâøË™çÊ∏à„Åø: ${approved}‰ª∂\nüü° ÂØ©Êüª‰∏≠: ${review}‰ª∂\n‚ö™ ËçâÊ°à: ${draft}‰ª∂\n\nÂêÑÊîøÁ≠ñ„ÅÆË©≥Á¥∞„Å™ÈÄ≤ÊçóÁä∂Ê≥Å„Å´„Å§„ÅÑ„Å¶„ÇÇ„ÅäËÅû„Åã„Åõ„Åß„Åç„Åæ„Åô„ÄÇ`;
    }
    
    if (message.includes('„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ„Éº') || message.includes('Èñ¢‰øÇËÄÖ')) {
      const allStakeholders = new Set(policies.flatMap(p => p.stakeholders));
      return `‰∏ª„Å™„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ„ÉºÂàÜÊûêÔºö\n\nÂèÇÂä†ÁµÑÁπîÊï∞: ${allStakeholders.size}\n‰∏ªË¶Å„Å™Èñ¢‰øÇËÄÖ: ${Array.from(allStakeholders).slice(0, 5).join(', ')}\n\nÁâπÂÆö„ÅÆÊîøÁ≠ñ„Å´„Åä„Åë„Çã„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ„Éº„ÅÆÂΩπÂâ≤„ÇÑÂΩ±Èüø„Å´„Å§„ÅÑ„Å¶„ÇÇË©≥„Åó„ÅèË™¨Êòé„Åß„Åç„Åæ„Åô„ÄÇ`;
    }
    
    // „Éá„Éï„Ç©„É´„ÉàÂøúÁ≠î
    return `„ÅîË≥™Âïè„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÊîøÁ≠ñ„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÈñ¢ÈÄ£ÊÉÖÂ†±„ÇíÊ§úÁ¥¢„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\n‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™ÂàÜÊûê„ÅåÂèØËÉΩ„Åß„ÅôÔºö\n‚Ä¢ ÊîøÁ≠ñ„ÅÆÂΩ±ÈüøÂ∫¶ÂàÜÊûê\n‚Ä¢ ‰∫àÁÆóÈÖçÂàÜ„ÅÆÊúÄÈÅ©ÂåñÊèêÊ°à\n‚Ä¢ „Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ„ÉºÂàÜÊûê\n‚Ä¢ ÂÆüË£Ö„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÅÆ‰ΩúÊàê\n\n„Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™„ÅîË≥™Âïè„Çí„ÅÑ„Åü„Å†„Åë„Çå„Å∞„ÄÅË©≥Á¥∞„Å™ÂàÜÊûêÁµêÊûú„Çí„ÅîÊèê‰æõ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ`;
  };

  const handleSendMessage = async () => {
    if (!inputMessage.trim() || isTyping) return;

    const userMessage: ChatMessage = {
      id: Date.now().toString(),
      type: 'user',
      content: inputMessage.trim(),
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage('');
    setIsTyping(true);

    // Simulate AI thinking time
    setTimeout(() => {
      const botResponse: ChatMessage = {
        id: (Date.now() + 1).toString(),
        type: 'bot',
        content: generateBotResponse(inputMessage),
        timestamp: new Date(),
        policyReferences: inputMessage.toLowerCase().includes('ÊîøÁ≠ñ') ? ['1', '2'] : undefined
      };

      setMessages(prev => [...prev, botResponse]);
      setIsTyping(false);
    }, 1500 + Math.random() * 1000);
  };

  const handleQuickAction = (action: string) => {
    setInputMessage(action);
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  return (
    <ChatbotContainer>
      <ChatbotHeader>
        <HeaderTitle>
          ü§ñ ÊîøÁ≠ñAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà
        </HeaderTitle>
        <HeaderDescription>
          ÊîøÁ≠ñ„Éá„Éº„Çø„ÅÆÂàÜÊûê„ÉªÊØîËºÉ„ÉªÊèêÊ°à„ÇíAI„Åå„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô
        </HeaderDescription>
        <StatusIndicator online={isOnline}>
          <StatusDot online={isOnline} />
          {isOnline ? '„Ç™„É≥„É©„Ç§„É≥' : '„Ç™„Éï„É©„Ç§„É≥'}
        </StatusIndicator>
      </ChatbotHeader>

      <ChatMessages>
        {messages.map((message) => (
          <div key={message.id}>
            <MessageBubble type={message.type}>
              {message.content}
              {message.policyReferences && (
                <div>
                  {message.policyReferences.map(refId => {
                    const policy = policies.find(p => p.id === refId);
                    return policy ? (
                      <PolicyReference key={refId}>
                        üìã {policy.title}
                      </PolicyReference>
                    ) : null;
                  })}
                </div>
              )}
              <MessageTime>
                {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
              </MessageTime>
            </MessageBubble>
          </div>
        ))}
        
        {isTyping && (
          <TypingIndicator>
            <TypingDots>
              <span />
              <span />
              <span />
            </TypingDots>
            AI„ÅåÂõûÁ≠î„ÇíÁîüÊàê‰∏≠...
          </TypingIndicator>
        )}
        <div ref={messagesEndRef} />
      </ChatMessages>

      <InputSection>
        <QuickActions>
          {quickActions.map((action, index) => (
            <QuickActionButton
              key={index}
              onClick={() => handleQuickAction(action)}
            >
              {action}
            </QuickActionButton>
          ))}
        </QuickActions>
        
        <InputContainer>
          <MessageInput
            value={inputMessage}
            onChange={(e) => setInputMessage(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="ÊîøÁ≠ñ„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
            rows={1}
          />
          <SendButton
            onClick={handleSendMessage}
            disabled={!inputMessage.trim() || isTyping}
          >
            {isTyping ? '‚è≥' : 'üì§'}
          </SendButton>
        </InputContainer>
      </InputSection>
    </ChatbotContainer>
  );
};

export default PolicyChatbot;